<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My ATprotocol Blog</title>
    <style>
        :root {
            /* Light theme variables */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1a202c;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --border-hover: #9ca3af;
            --accent-primary: #6366f1;
            --accent-hover: #4f46e5;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-hover: rgba(0, 0, 0, 0.12);
            --code-bg: #f1f5f9;
            --code-color: #6366f1;
            --pre-bg: #1e293b;
            --pre-color: #e2e8f0;
            --blockquote-bg: #f8fafc;
            --error-bg: linear-gradient(135deg, #fee2e2, #fecaca);
            --error-border: #f87171;
            --error-color: #dc2626;
            --footer-bg: #1e293b;
            --footer-color: #94a3b8;
        }

        .dark-theme {
            /* Dark theme variables */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-light: #64748b;
            --border-color: #334155;
            --border-hover: #475569;
            --accent-primary: #818cf8;
            --accent-hover: #6366f1;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.4);
            --code-bg: #334155;
            --code-color: #818cf8;
            --pre-bg: #0f172a;
            --pre-color: #e2e8f0;
            --blockquote-bg: #1e293b;
            --error-bg: linear-gradient(135deg, #7f1d1d, #991b1b);
            --error-border: #dc2626;
            --error-color: #fca5a5;
            --footer-bg: #020617;
            --footer-color: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-hover);
        }

        .header-image {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(168, 85, 247, 0.8)), 
                        url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            text-align: center;
            color: white;
            z-index: 2;
            max-width: 800px;
            padding: 40px 20px;
        }

        .header-content h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 2px 4px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: -0.02em;
        }

        .header-content p {
            font-size: 1.3rem;
            font-weight: 400;
            opacity: 0.95;
            text-shadow: 1px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .loading-section {
            text-align: center;
            padding: 60px 20px;
            margin: 40px 0;
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            color: var(--error-color);
            padding: 24px;
            border-radius: 16px;
            margin: 40px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(248, 113, 113, 0.15);
        }

        .blog-info {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            margin: 40px 0;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .blog-info h2 {
            color: var(--text-secondary);
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .blog-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .blog-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 0;
        }

        .blog-info-item .icon {
            font-size: 1.2rem;
        }

        .blog-info-item .label {
            font-weight: 600;
            color: var(--text-muted);
        }

        .blog-info-item .value {
            color: var(--text-secondary);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .navigation-bar {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--accent-primary);
            color: white;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .back-button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .blog-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .posts-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .posts-per-page select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .posts-per-page label {
            font-weight: 500;
            color: var(--text-muted);
        }

        .blog-posts {
            margin: 40px 0;
        }

        .blog-post {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .blog-post::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .blog-post:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px var(--shadow-hover);
        }

        .blog-post:hover::before {
            opacity: 1;
        }

        .blog-post h2 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .blog-post h2 a {
            color: var(--text-primary);
            text-decoration: none;
            position: relative;
            transition: color 0.3s ease;
        }

        .blog-post h2 a:hover {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .blog-post h2 a::after {
            content: 'üîó';
            opacity: 0;
            margin-left: 8px;
            font-size: 0.7em;
            transition: opacity 0.2s ease;
        }

        .blog-post h2 a:hover::after {
            opacity: 0.7;
        }

        .blog-post-meta {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .blog-post-meta .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .blog-post-meta .meta-item .icon {
            font-size: 1rem;
        }

        .blog-post-content {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.7;
        }

        .blog-post-content h1,
        .blog-post-content h2,
        .blog-post-content h3,
        .blog-post-content h4 {
            color: var(--text-primary);
            margin: 30px 0 15px 0;
            font-weight: 700;
        }

        .blog-post-content h1 { font-size: 2rem; }
        .blog-post-content h2 { font-size: 1.6rem; }
        .blog-post-content h3 { font-size: 1.3rem; }
        .blog-post-content h4 { font-size: 1.1rem; }

        .blog-post-content p {
            margin-bottom: 20px;
        }

        .blog-post-content blockquote {
            border-left: 4px solid var(--accent-primary);
            padding: 20px 30px;
            margin: 30px 0;
            background: var(--blockquote-bg);
            font-style: italic;
            color: var(--text-light);
            border-radius: 0 8px 8px 0;
        }

        .blog-post-content code {
            background: var(--code-bg);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: var(--code-color);
        }

        .blog-post-content pre {
            background: var(--pre-bg);
            color: var(--pre-color);
            padding: 25px;
            border-radius: 12px;
            overflow-x: auto;
            margin: 25px 0;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .blog-post-content pre code {
            background: none;
            padding: 0;
            color: var(--pre-color);
        }

        .blog-post-content a {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .blog-post-content a:hover {
            text-decoration: underline;
        }

        .blog-post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: block;
        }

        .blog-post-content img.center {
            margin-left: auto;
            margin-right: auto;
        }

        .blog-post-content figure {
            margin: 30px 0;
            text-align: center;
        }

        .blog-post-content figcaption {
            font-style: italic;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 0 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 44px;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .pagination button.active:hover {
            background: var(--accent-hover);
        }

        .pagination .page-info {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin: 0 15px;
            white-space: nowrap;
        }

        .pagination .ellipsis {
            color: var(--border-hover);
            font-weight: bold;
            padding: 0 8px;
        }

        .no-posts {
            text-align: center;
            padding: 80px 20px;
            background: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .no-posts .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-posts h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .no-posts p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .single-post-view .blog-post {
            box-shadow: 0 8px 30px var(--shadow-hover);
        }

        .single-post-view .blog-post::before {
            opacity: 1;
        }

        .footer {
            background: var(--footer-bg);
            color: var(--footer-color);
            text-align: center;
            padding: 40px 20px;
            margin-top: 60px;
            transition: all 0.3s ease;
        }

        .footer p {
            margin-bottom: 10px;
        }

        .footer a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .theme-toggle {
                top: 15px;
                right: 15px;
                width: 44px;
                height: 44px;
                font-size: 1rem;
            }

            .header-content h1 {
                font-size: 2.5rem;
            }
            
            .header-content p {
                font-size: 1.1rem;
            }
            
            .header-image {
                height: 250px;
            }
            
            .blog-post {
                padding: 25px;
            }
            
            .blog-post h2 {
                font-size: 1.6rem;
            }
            
            .blog-info-grid {
                grid-template-columns: 1fr;
            }

            .blog-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination {
                gap: 5px;
            }

            .pagination button {
                padding: 10px 12px;
                font-size: 0.8rem;
                min-width: 36px;
            }

            .pagination .page-info {
                font-size: 0.8rem;
                margin: 0 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle" id="themeToggle" title="Toggle dark/light mode">
        üåô
    </div>

    <!-- ===== CUSTOMIZABLE CONFIGURATION ===== -->
    <script>
        // üé® CUSTOMIZE YOUR BLOG HERE
        const CONFIG = {
            // ATprotocol handle to display
            handle: 'kayrozen.com',
            
            // Blog title
            title: 'My Personal Blog',
            
            // Blog description
            description: 'My thoughts, discoveries and adventures in the digital world',
            
            // Header image URL (change to your own image)
            headerImage: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80',
            
            // Header gradient colors (optional)
            gradientColors: 'linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(168, 85, 247, 0.8))',
            
            // Theme configuration
            theme: {
                // Set to 'dark' for dark mode by default, 'light' for light mode
                defaultMode: 'dark',
                // Allow users to toggle theme
                allowToggle: true
            },
            
            // Pagination configuration
            pagination: {
                defaultPostsPerPage: 5,
                postsPerPageOptions: [3, 5, 10, 20]
            }
        };
    </script>

    <div class="header-image" id="headerImage">
        <div class="header-overlay"></div>
        <div class="header-content">
            <h1 id="blogTitle">Explikay</h1>
            <p id="blogDescription">My thoughts, discoveries and adventures in the ATmosphere</p>
        </div>
    </div>

    <div class="container">
        <div class="navigation-bar" id="navigationBar" style="display: none;">
            <button class="back-button" onclick="showAllPosts()">
                ‚Üê Back to all posts
            </button>
        </div>

        <div class="blog-info" id="blogInfo" style="display: none;">
            <h2>üìñ Blog Information</h2>
            <div class="blog-info-grid">
                <div class="blog-info-item">
                    <span class="icon">üë§</span>
                    <span class="label">Handle:</span>
                    <span class="value" id="handleDisplay"></span>
                </div>
                <div class="blog-info-item">
                    <span class="icon">üåê</span>
                    <span class="label">PDS:</span>
                    <span class="value" id="pdsDisplay"></span>
                </div>
                <div class="blog-info-item">
                    <span class="icon">üìù</span>
                    <span class="label">Total posts:</span>
                    <span class="value" id="postsCount"></span>
                </div>
                <div class="blog-info-item">
                    <span class="icon">üîÑ</span>
                    <span class="label">Last updated:</span>
                    <span class="value" id="lastUpdate"></span>
                </div>
            </div>
        </div>

        <div class="blog-controls" id="blogControls" style="display: none;">
            <div class="posts-per-page">
                <label for="postsPerPage">Posts per page:</label>
                <select id="postsPerPage">
                    <option value="3">3</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                </select>
            </div>
            <div class="page-info" id="pageInfo">
                Page 1 of 1
            </div>
        </div>

        <div id="loadingSection" class="loading-section">
            <div class="spinner"></div>
            <p>Loading blog posts...</p>
        </div>

        <div id="errorSection" style="display: none;"></div>
        <div id="blogPosts" class="blog-posts"></div>
        
        <div class="pagination" id="pagination" style="display: none;"></div>
    </div>

    <footer class="footer">
        <p>Powered by <strong>ATprotocol</strong> and <strong>Whitewind Blog</strong></p>
        <p>Personal blog of <span id="footerHandle"></span></p>
    </footer>

    <script>
        class ThemeManager {
            constructor(config) {
                this.config = config;
                this.currentTheme = this.getStoredTheme() || config.defaultMode;
                this.themeToggle = document.getElementById('themeToggle');
                
                this.init();
            }

            init() {
                this.applyTheme(this.currentTheme);
                this.updateToggleIcon();
                
                if (this.config.allowToggle) {
                    this.themeToggle.addEventListener('click', () => this.toggle());
                } else {
                    this.themeToggle.style.display = 'none';
                }
            }

            getStoredTheme() {
                try {
                    return localStorage.getItem('blog-theme');
                } catch (e) {
                    return null;
                }
            }

            storeTheme(theme) {
                try {
                    localStorage.setItem('blog-theme', theme);
                } catch (e) {
                    // localStorage not available, ignore
                }
            }

            applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
                this.currentTheme = theme;
                this.storeTheme(theme);
            }

            updateToggleIcon() {
                this.themeToggle.textContent = this.currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                this.themeToggle.title = this.currentTheme === 'dark' 
                    ? 'Switch to light mode' 
                    : 'Switch to dark mode';
            }

            toggle() {
                const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                this.applyTheme(newTheme);
                this.updateToggleIcon();
            }
        }

        class PersonalBlogViewer {
            constructor(config) {
                this.config = config;
                this.themeManager = new ThemeManager(config.theme);
                this.allPosts = [];
                this.currentPage = 1;
                this.postsPerPage = config.pagination.defaultPostsPerPage;
                this.singlePostMode = false;
                this.currentPostId = null;
                
                this.loadingSection = document.getElementById('loadingSection');
                this.errorSection = document.getElementById('errorSection');
                this.blogPosts = document.getElementById('blogPosts');
                this.blogInfo = document.getElementById('blogInfo');
                this.blogControls = document.getElementById('blogControls');
                this.pagination = document.getElementById('pagination');
                this.pageInfo = document.getElementById('pageInfo');
                this.navigationBar = document.getElementById('navigationBar');
                
                this.init();
            }

            init() {
                this.applyConfig();
                this.setupEventListeners();
                this.checkURL();
                this.loadBlogPosts();
            }

            applyConfig() {
                document.getElementById('blogTitle').textContent = this.config.title;
                document.getElementById('blogDescription').textContent = this.config.description;
                document.getElementById('footerHandle').textContent = this.config.handle;
                document.title = this.config.title;
                
                const headerImage = document.getElementById('headerImage');
                headerImage.style.background = `${this.config.gradientColors}, url('${this.config.headerImage}')`;
                headerImage.style.backgroundSize = 'cover';
                headerImage.style.backgroundPosition = 'center';

                // Configure posts per page selector
                const postsPerPageSelect = document.getElementById('postsPerPage');
                postsPerPageSelect.innerHTML = '';
                this.config.pagination.postsPerPageOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    if (option === this.postsPerPage) {
                        optionElement.selected = true;
                    }
                    postsPerPageSelect.appendChild(optionElement);
                });
            }

            setupEventListeners() {
                document.getElementById('postsPerPage').addEventListener('change', (e) => {
                    this.postsPerPage = parseInt(e.target.value);
                    this.currentPage = 1;
                    this.displayCurrentPage();
                });

                // Listen for URL changes
                window.addEventListener('popstate', (e) => {
                    this.checkURL();
                    this.updateView();
                });
            }

            checkURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('post');
                
                if (postId) {
                    this.singlePostMode = true;
                    this.currentPostId = postId;
                } else {
                    this.singlePostMode = false;
                    this.currentPostId = null;
                }
            }

            generatePostId(post) {
                // Generate unique ID based on post URI
                const uriParts = post.uri.split('/');
                return uriParts[uriParts.length - 1];
            }

            showSinglePost(postId) {
                this.singlePostMode = true;
                this.currentPostId = postId;
                
                // Update URL without reloading page
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('post', postId);
                window.history.pushState({}, '', newUrl);
                
                this.updateView();
            }

            showAllPosts() {
                this.singlePostMode = false;
                this.currentPostId = null;
                
                // Update URL without reloading page
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('post');
                window.history.pushState({}, '', newUrl);
                
                this.updateView();
            }

            updateView() {
                if (this.singlePostMode && this.currentPostId) {
                    this.displaySinglePost();
                } else {
                    this.displayCurrentPage();
                }
            }

            async loadBlogPosts() {
                try {
                    const did = await this.resolveDID(this.config.handle);
                    const pds = await this.resolvePDS(did);
                    const posts = await this.getBlogPosts(did, pds);
                    
                    this.allPosts = posts;
                    this.displayBlogInfo(this.config.handle, pds, posts.length);
                    
                    if (posts.length > 0) {
                        this.updateView();
                        if (!this.singlePostMode) {
                            this.blogControls.style.display = 'flex';
                        }
                    } else {
                        this.displayCurrentPage();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.showError(`Loading error: ${error.message}`);
                }
            }

            async resolveDID(handle) {
                const response = await fetch(`https://bsky.social/xrpc/com.atproto.identity.resolveHandle?handle=${handle}`);
                if (!response.ok) {
                    throw new Error(`Unable to resolve handle: ${handle}`);
                }
                const data = await response.json();
                return data.did;
            }

            async resolvePDS(did) {
                const response = await fetch(`https://plc.directory/${did}`);
                if (!response.ok) {
                    throw new Error(`Unable to fetch DID document: ${response.status}`);
                }
                
                const didDoc = await response.json();
                const pdsService = didDoc.service?.find(service => 
                    service.type === 'AtprotoPersonalDataServer'
                );
                
                if (!pdsService || !pdsService.serviceEndpoint) {
                    throw new Error('No PDS found in DID document');
                }
                
                return pdsService.serviceEndpoint;
            }

            async getBlogPosts(did, pds) {
                const response = await fetch(`${pds}/xrpc/com.atproto.repo.listRecords?repo=${did}&collection=com.whtwnd.blog.entry`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return [];
                    }
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                const posts = data.records?.map(record => ({
                    uri: record.uri,
                    cid: record.cid,
                    createdAt: record.value.createdAt,
                    title: record.value.title,
                    content: record.value.content,
                    theme: record.value.theme,
                    visibility: record.value.visibility,
                    id: this.generatePostId(record),
                    ...record.value
                })) || [];
                
                posts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                return posts;
            }

            displayBlogInfo(handle, pds, postsCount) {
                document.getElementById('handleDisplay').textContent = handle;
                document.getElementById('pdsDisplay').textContent = pds;
                document.getElementById('postsCount').textContent = postsCount;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('en-US');
                
                this.blogInfo.style.display = 'block';
            }

            displaySinglePost() {
                this.loadingSection.style.display = 'none';
                this.blogControls.style.display = 'none';
                this.pagination.style.display = 'none';
                this.navigationBar.style.display = 'block';
                
                const post = this.allPosts.find(p => p.id === this.currentPostId);
                
                if (!post) {
                    this.blogPosts.innerHTML = `
                        <div class="no-posts">
                            <div class="icon">‚ùå</div>
                            <h3>Post not found</h3>
                            <p>The requested post does not exist or could not be loaded.</p>
                        </div>
                    `;
                    return;
                }

                this.blogPosts.innerHTML = `<div class="single-post-view">${this.renderPost(post, false)}</div>`;
                
                // Update page title
                document.title = `${post.title || 'Untitled'} - ${this.config.title}`;
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            displayCurrentPage() {
                this.loadingSection.style.display = 'none';
                this.navigationBar.style.display = 'none';
                
                // Restore original title
                document.title = this.config.title;
                
                if (!this.allPosts || this.allPosts.length === 0) {
                    this.blogPosts.innerHTML = `
                        <div class="no-posts">
                            <div class="icon">üìù</div>
                            <h3>No posts published</h3>
                            <p>This blog doesn't contain any posts yet.</p>
                        </div>
                    `;
                    this.pagination.style.display = 'none';
                    this.blogControls.style.display = 'none';
                    return;
                }

                const totalPages = Math.ceil(this.allPosts.length / this.postsPerPage);
                const startIndex = (this.currentPage - 1) * this.postsPerPage;
                const endIndex = startIndex + this.postsPerPage;
                const currentPosts = this.allPosts.slice(startIndex, endIndex);

                // Display posts
                const postsHTML = currentPosts.map(post => this.renderPost(post, true)).join('');
                this.blogPosts.innerHTML = postsHTML;

                // Update page info
                this.pageInfo.textContent = `Page ${this.currentPage} of ${totalPages}`;

                // Show pagination if necessary
                if (totalPages > 1) {
                    this.renderPagination(totalPages);
                    this.pagination.style.display = 'flex';
                } else {
                    this.pagination.style.display = 'none';
                }

                // Show controls
                this.blogControls.style.display = 'flex';

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            renderPagination(totalPages) {
                const paginationHTML = this.generatePaginationButtons(totalPages);
                this.pagination.innerHTML = paginationHTML;

                // Add events
                this.pagination.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        const page = parseInt(e.target.dataset.page);

                        if (action === 'prev' && this.currentPage > 1) {
                            this.currentPage--;
                        } else if (action === 'next' && this.currentPage < totalPages) {
                            this.currentPage++;
                        } else if (action === 'first') {
                            this.currentPage = 1;
                        } else if (action === 'last') {
                            this.currentPage = totalPages;
                        } else if (page && page !== this.currentPage) {
                            this.currentPage = page;
                        }

                        this.displayCurrentPage();
                    });
                });
            }

            generatePaginationButtons(totalPages) {
                let buttons = [];

                // First page button
                buttons.push(`
                    <button data-action="first" ${this.currentPage === 1 ? 'disabled' : ''}>
                        ‚ü™
                    </button>
                `);

                // Previous page button
                buttons.push(`
                    <button data-action="prev" ${this.currentPage === 1 ? 'disabled' : ''}>
                        ‚ü®
                    </button>
                `);

                // Page buttons
                const pageButtons = this.generatePageButtons(totalPages);
                buttons.push(pageButtons);

                // Next page button
                buttons.push(`
                    <button data-action="next" ${this.currentPage === totalPages ? 'disabled' : ''}>
                        ‚ü©
                    </button>
                `);

                // Last page button
                buttons.push(`
                    <button data-action="last" ${this.currentPage === totalPages ? 'disabled' : ''}>
                        ‚ü´
                    </button>
                `);

                return buttons.join('');
            }

            generatePageButtons(totalPages) {
                let buttons = [];
                const current = this.currentPage;

                if (totalPages <= 7) {
                    // Show all pages if less than 7
                    for (let i = 1; i <= totalPages; i++) {
                        buttons.push(`
                            <button data-page="${i}" ${i === current ? 'class="active"' : ''}>
                                ${i}
                            </button>
                        `);
                    }
                } else {
                    // Logic for more than 7 pages
                    if (current <= 4) {
                        // Beginning: 1 2 3 4 5 ... 10
                        for (let i = 1; i <= 5; i++) {
                            buttons.push(`
                                <button data-page="${i}" ${i === current ? 'class="active"' : ''}>
                                    ${i}
                                </button>
                            `);
                        }
                        buttons.push('<span class="ellipsis">...</span>');
                        buttons.push(`
                            <button data-page="${totalPages}">
                                ${totalPages}
                            </button>
                        `);
                    } else if (current >= totalPages - 3) {
                        // End: 1 ... 6 7 8 9 10
                        buttons.push(`
                            <button data-page="1">
                                1
                            </button>
                        `);
                        buttons.push('<span class="ellipsis">...</span>');
                        for (let i = totalPages - 4; i <= totalPages; i++) {
                            buttons.push(`
                                <button data-page="${i}" ${i === current ? 'class="active"' : ''}>
                                    ${i}
                                </button>
                            `);
                        }
                    } else {
                        // Middle: 1 ... 4 5 6 ... 10
                        buttons.push(`
                            <button data-page="1">
                                1
                            </button>
                        `);
                        buttons.push('<span class="ellipsis">...</span>');
                        for (let i = current - 1; i <= current + 1; i++) {
                            buttons.push(`
                                <button data-page="${i}" ${i === current ? 'class="active"' : ''}>
                                    ${i}
                                </button>
                            `);
                        }
                        buttons.push('<span class="ellipsis">...</span>');
                        buttons.push(`
                            <button data-page="${totalPages}">
                                ${totalPages}
                            </button>
                        `);
                    }
                }

                return buttons.join('');
            }

            renderPost(post, showPermalink = true) {
                const createdAt = new Date(post.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const content = this.renderContent(post.content || '');
                const theme = post.theme || 'default';
                const postId = post.id;
                
                const titleElement = showPermalink 
                    ? `<h2><a href="?post=${postId}" onclick="event.preventDefault(); blogViewer.showSinglePost('${postId}')">${this.escapeHtml(post.title || 'Untitled')}</a></h2>`
                    : `<h2>${this.escapeHtml(post.title || 'Untitled')}</h2>`;
                
                return `
                    <article class="blog-post">
                        ${titleElement}
                        <div class="blog-post-meta">
                            <div class="meta-item">
                                <span class="icon">üìÖ</span>
                                <span>${createdAt}</span>
                            </div>
                            <div class="meta-item">
                                <span class="icon">üé®</span>
                                <span>${this.escapeHtml(theme)}</span>
                            </div>
                            ${post.visibility ? `
                                <div class="meta-item">
                                    <span class="icon">üëÅÔ∏è</span>
                                    <span>${this.escapeHtml(post.visibility)}</span>
                                </div>
                            ` : ''}
                            ${showPermalink ? `
                                <div class="meta-item">
                                    <span class="icon">üîó</span>
                                    <span><a href="?post=${postId}" onclick="event.preventDefault(); navigator.clipboard.writeText(window.location.origin + window.location.pathname + '?post=${postId}'); alert('Link copied to clipboard!')">Permalink</a></span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="blog-post-content">
                            ${content}
                        </div>
                    </article>
                `;
            }

            renderContent(content) {
                if (!content) return '<p>Content not available</p>';
                
                let html = content;
                
                // Basic markdown conversion
                html = html.replace(/^#### (.*$)/gm, '<h4>$1</h4>');
                html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/`(.*?)`/g, '<code>$1</code>');
                html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                
                // Images with optional caption
                html = html.replace(/!\[([^\]]*)\]\(([^)]+)\s+"([^"]+)"\)/g, 
                    '<figure><img src="$2" alt="$1" title="$3"><figcaption>$3</figcaption></figure>');
                
                // Simple images
                html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, 
                    '<img src="$2" alt="$1" class="center">');
                
                // Links
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
                
                // Blockquotes
                html = html.replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
                
                // Unordered lists
                html = html.replace(/^\* (.+$)/gm, '<li>$1</li>');
                html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
                
                // Ordered lists
                html = html.replace(/^\d+\. (.+$)/gm, '<li>$1</li>');
                html = html.replace(/(<li>.*<\/li>)/gs, match => {
                    if (!match.includes('<ul>')) {
                        return `<ol>${match}</ol>`;
                    }
                    return match;
                });
                
                // Paragraphs
                html = html.split('\n\n').map(p => {
                    p = p.trim();
                    if (!p) return '';
                    
                    // Don't wrap in <p> if it's already a block element
                    if (p.startsWith('<h') || p.startsWith('<ul') || p.startsWith('<ol') || 
                        p.startsWith('<blockquote') || p.startsWith('<pre') || 
                        p.startsWith('<figure') || p.startsWith('<img')) {
                        return p;
                    }
                    
                    return `<p>${p.replace(/\n/g, '<br>')}</p>`;
                }).join('');
                
                return html;
            }

            showError(message) {
                this.loadingSection.style.display = 'none';
                this.errorSection.style.display = 'block';
                this.errorSection.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${message}
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Global variable to access the viewer
        let blogViewer;

        // Global function to return to all posts
        function showAllPosts() {
            blogViewer.showAllPosts();
        }

        // Initialize blog with configuration
        document.addEventListener('DOMContentLoaded', () => {
            blogViewer = new PersonalBlogViewer(CONFIG);
        });
    </script>
</body>
</html>
